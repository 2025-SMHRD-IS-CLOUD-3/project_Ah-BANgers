<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ïó∞Î†π ÌåêÎ≥Ñ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f0f0f0;
            cursor: pointer;
        }
        
        .kiosk-container {
            width: 100% !important;
            height: 100% !important;
            position: relative;
            background: #FFF9E7;
            overflow: hidden;
            border-radius: 0;
            outline: none;
            outline-offset: 0;
            /* Ïô∏Í≥ΩÏÑ†Ïóê ÏôÑÏ†ÑÌûà ÍΩâ Ï∞®ÎèÑÎ°ù Í∞ïÏ†ú Ï†ÅÏö© */
            margin: 0 !important;
            padding: 0 !important;
            /* Ïô∏Í≥ΩÏÑ† Í≤ΩÍ≥ÑÏóê Îî± ÎßûÏ∂§ */
            min-width: 100%;
            min-height: 100%;
            max-width: 100%;
            max-height: 100%;
        }
        
        .camera-frame {
            width: 600px;
            height: 500px;
            left: 240px;
            top: 500px;
            position: absolute;
            border: 6px solid #333;
            border-radius: 30px;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .camera-frame::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 40px;
        }
        
        .camera-icon {
            font-size: 150px;
            color: #333;
            animation: pulse 1.5s infinite;
            z-index: 2;
            position: relative;
        }
        
        .scanning-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4CAF50, transparent);
            top: 0;
            animation: scan 2s linear infinite;
            z-index: 3;
        }
        
        .scanning-line::before {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background: #4CAF50;
            border-radius: 50%;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 15px #4CAF50;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        .title {
            width: 800px;
            height: 300px;
            left: 140px;
            top: 150px;
            position: absolute;
            text-align: center;
            color: black;
            font-size: 120px;
            font-family: Inter;
            font-weight: 900;
            word-wrap: break-word;
            text-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }
        
        .status-text {
            width: 800px;
            height: 200px;
            left: 140px;
            top: 1100px;
            position: absolute;
            text-align: center;
            justify-content: center;
            display: flex;
            flex-direction: column;
            color: black;
            font-size: 72px;
            font-family: Inter;
            font-weight: 700;
            word-wrap: break-word;
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }
        
        .progress-bar {
            width: 800px;
            height: 15px;
            left: 140px;
            top: 1350px;
            position: absolute;
            background: #E0E0E0;
            border-radius: 8px;
            overflow: hidden;
            z-index: 2;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
            border-radius: 8px;
            width: 0%;
            transition: width 0.1s ease;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
        }
        
        .age-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px;
            font-weight: 900;
            color: #00ff88;
            text-shadow: 0 0 30px #00ff88;
            opacity: 0;
            z-index: 4;
            animation: resultShow 2s ease-in-out forwards;
        }
        
        @keyframes resultShow {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .success-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.2) 0%, transparent 70%);
            opacity: 0;
            animation: successPulse 0.8s ease-in-out forwards;
            z-index: 5;
        }
        
        @keyframes successPulse {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body onclick="startAgeDetection()">
    <div class="kiosk-frame">
        <div class="kiosk-container">
            <div class="title">AI Ïó∞Î†π<br/>ÌåêÎ≥Ñ Ï§ë</div>
            
            <div class="camera-frame">
                <div class="camera-icon">üì∑</div>
                <div class="scanning-line"></div>
            </div>
            
            <div class="status-text">Ïπ¥Î©îÎùºÎ°ú Ïó∞Î†πÏùÑ<br/>Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="success-effect hidden" id="successEffect"></div>
            
            <!-- Ïπ¥Î©îÎùº ÎØ∏Î¶¨Î≥¥Í∏∞ÏôÄ Ï∫îÎ≤ÑÏä§Îäî ÌôîÎ©¥Ïóê Î≥¥Ïù¥ÏßÄ ÏïäÍ≤å Ïà®Í≤®ÎëòÍ≤åÏöî -->
            <video id="camera" autoplay playsinline style="display:none; position:absolute; left:24px; bottom:24px; width:240px; height:180px; border-radius: 12px; border: 2px solid #000; opacity: .2;"></video>
            <canvas id="snapshot" width="640" height="480" style="display:none;"></canvas>
        </div>
    </div>
    
    <script>
        // Ï¥àÎì±ÌïôÏÉùÎèÑ Ïù¥Ìï¥Ìï† Ïàò ÏûàÎèÑÎ°ù Ïâ¨Ïö¥ ÎßêÎ°ú Ï£ºÏÑùÏùÑ Îã¨ÏïÑÎëêÏóàÏñ¥Ïöî!
        // 1) ÏÑúÎ≤Ñ Ï£ºÏÜåÎ•º Ï†ÅÏñ¥Îë°ÎãàÎã§. (Flask ÏÑúÎ≤ÑÍ∞Ä Ïù¥ Ï£ºÏÜåÎ°ú Ïó¥Î†§ÏûàÏñ¥Ïöî)
        const API_BASE = 'http://localhost:5000';
        
        // 2) ÌôîÎ©¥Ïùò Î¨∏Íµ¨ÏôÄ Ïπ¥Î©îÎùº ÏöîÏÜåÎ•º Ï∞æÏïÑÏöî
        const $video = document.getElementById('camera');
        const $canvas = document.getElementById('snapshot');
        
        let isDetecting = false;
        let progress = 0;
        let analyzedAvg = null; // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÎÇòÏù¥ ÌèâÍ∑†ÏùÑ Ïó¨Í∏∞Ïóê Ï†ÄÏû•Ìï†Í≤åÏöî
        
        function startAgeDetection() {
            if (isDetecting) return;
            
            isDetecting = true;
            progress = 0;
            
            // ÏßÑÌñâÎ•† Î∞î Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë (Îçî Ï≤úÏ≤úÌûà)
            const progressFill = document.getElementById('progressFill');
            const statusText = document.querySelector('.status-text');
            
            const progressInterval = setInterval(() => {
                progress += 2; // 5 ‚Üí 2Î°ú Ï§ÑÏó¨ÏÑú Îçî Ï≤úÏ≤úÌûà
                progressFill.style.width = progress + '%';
                
                // ÏßÑÌñâÎ•†Ïù¥ 90%ÍπåÏßÄÎßå Í∞ÄÍ≥†, Ïã§Ï†ú Î∂ÑÏÑù ÏôÑÎ£å ÌõÑ 100%Î°ú ÏôÑÏÑ±
                if (progress >= 90) {
                    clearInterval(progressInterval);
                    // Ïó¨Í∏∞ÏÑúÎäî showDetectionComplete()Î•º Ìò∏Ï∂úÌïòÏßÄ ÏïäÏùå
                }
            }, 150); // 100ms ‚Üí 150msÎ°ú ÎäòÎ†§ÏÑú Îçî Ï≤úÏ≤úÌûà
            
            // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            setTimeout(() => {
                statusText.innerHTML = 'ÏñºÍµ¥ Ïù∏Ïãù Ï§ë...<br/>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî';
            }, 800);
            
            setTimeout(() => {
                statusText.innerHTML = 'Ïó∞Î†π Î∂ÑÏÑù Ï§ë...<br/>Í±∞Ïùò ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§';
            }, 2000); // 1500 ‚Üí 2000ÏúºÎ°ú ÎäòÎ¶º

            // 3) Ïã§Ï†úÎ°ú Ïπ¥Î©îÎùºÎ°ú ÏÇ¨ÏßÑÏùÑ Ï∞çÍ≥†, ÏÑúÎ≤ÑÏóê Î≥¥ÎÇ¥ÏÑú ÎÇòÏù¥Î•º Î∂ÑÏÑùÌï¥Ïöî
            (async () => {
                try {
                    const shots = [];
                    // ÏÇ¨ÏßÑÏùÑ 2Ïû• Ï∞çÏñ¥ÏÑú Îçî Ï†ïÌôïÌïòÍ≤å Ìï¥Ïöî
                    for (let i = 0; i < 2; i++) {
                        const dataURL = await captureDataURL();
                        shots.push(dataURL);
                    }
                    const result = await analyzeOnServer(shots);
                    analyzedAvg = Math.round((result.average || 0));
                    
                    // Ïã§Ï†ú Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêú ÌõÑÏóêÎßå ÏßÑÌñâÎ•†ÏùÑ 100%Î°ú ÎßåÎì§Í≥† ÏôÑÎ£å Ï≤òÎ¶¨
                    progressFill.style.width = '100%';
                    showDetectionComplete();
                } catch (error) {
                    // ÏóêÎü¨Í∞Ä ÎÇòÎèÑ Í±±Ï†ïÌïòÏßÄ ÎßàÏÑ∏Ïöî. Í∏∞Î≥∏Í∞í 0ÏúºÎ°ú ÏßÑÌñâÌï¥Ïöî (ÏïàÏ†ÑÌïòÍ≤å)
                    analyzedAvg = 0;
                    console.error(error);
                    
                    // ÏóêÎü¨Í∞Ä ÎÇòÎèÑ ÏßÑÌñâÎ•†ÏùÑ 100%Î°ú ÎßåÎì§Í≥† ÏôÑÎ£å Ï≤òÎ¶¨
                    progressFill.style.width = '100%';
                    showDetectionComplete();
                }
            })();
        }
        
        function showDetectionComplete() {
            const statusText = document.querySelector('.status-text');
            const successEffect = document.getElementById('successEffect');
            
            // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
            statusText.innerHTML = 'Ïó∞Î†π ÌåêÏ†ï ÏôÑÎ£å!<br/>Ï£ºÎ¨∏ÏùÑ ÏãúÏûëÌï©ÎãàÎã§';
            
            // ÏÑ±Í≥µ Ìö®Í≥º ÌëúÏãú
            successEffect.classList.remove('hidden');
            
            // 1Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú Îã§Ïùå ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô (Î∂ÑÏÑùÎêú ÌèâÍ∑† ÎÇòÏù¥Î•º Í∏∞Ï§ÄÏúºÎ°ú Î∂ÑÍ∏∞)
            setTimeout(() => {
                const avg = typeof analyzedAvg === 'number' ? analyzedAvg : 0;
                goNext(avg);
            }, 1000);
        }

        // 4) ÏÑúÎ≤ÑÎ°ú ÏÇ¨ÏßÑÏùÑ Î≥¥ÎÇ¥ÏÑú ÌèâÍ∑† ÎÇòÏù¥Î•º Î∞õÏïÑÏöî
        async function analyzeOnServer(images){
            // ÏÑúÎ≤ÑÏóê JSONÏúºÎ°ú Î≥¥ÎÉÖÎãàÎã§. { images: [dataURL, dataURL] }
            const res = await fetch(API_BASE + '/analyze-age', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ images })
            });
            if (!res.ok) throw new Error('ÏÑúÎ≤Ñ ÏóêÎü¨: ' + res.status);
            return await res.json();
        }

        async function captureDataURL(){
            // Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÏöîÏ≤≠ÌïòÍ≥†, ÌôîÎ©¥Ïóê Î≥¥Ïù¥ÏßÄ ÏïäÍ≤å ÏòÅÏÉÅÏùÑ Î∞õÏïÑÏöî
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio:false });
            $video.srcObject = stream;
            // Ïπ¥Î©îÎùºÍ∞Ä ÏºúÏßà ÏãúÍ∞ÑÏùÑ Ï°∞Í∏à Í∏∞Îã§Î†§Ïöî
            await new Promise(r => setTimeout(r, 900));
            // ÎπÑÎîîÏò§Ïùò Ïã§Ï†ú ÎÑàÎπÑ/ÎÜíÏù¥Î•º Í∞ÄÏ†∏ÏôÄÏöî (ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©)
            const w = $video.videoWidth || 640; 
            const h = $video.videoHeight || 480;
            $canvas.width = w; 
            $canvas.height = h;
            // Ï∫îÎ≤ÑÏä§Ïóê ÌòÑÏû¨ ÌôîÎ©¥ÏùÑ Í∑∏Î†§Ïöî (ÏÇ¨ÏßÑ Ï∞çÍ∏∞)
            $canvas.getContext('2d').drawImage($video, 0, 0, w, h);
            // Base64 JPEG Îç∞Ïù¥ÌÑ∞Î°ú Î∞îÍøîÏÑú ÏÑúÎ≤ÑÏóê Î≥¥ÎÇº Ï§ÄÎπÑÎ•º Ìï¥Ïöî
            const dataURL = $canvas.toDataURL('image/jpeg', 0.9);
            // Ïπ¥Î©îÎùº ÎÅÑÍ∏∞ (ÏïàÏ†ÑÌïòÍ≤å ÏûêÏõê Ìï¥Ï†ú)
            stream.getTracks().forEach(t => t.stop());
            return dataURL;
        }

        // 6) ÌèâÍ∑† ÎÇòÏù¥Í∞Ä 65ÏÑ∏ Ïù¥ÏÉÅÏù¥Î©¥ order-type, ÏïÑÎãàÎ©¥ order-type2Î°ú Ïù¥ÎèôÌï¥Ïöî
        function goNext(avg){
            try { sessionStorage.setItem('ageAvg', String(avg)); } catch (e) {}
            const isSenior = avg >= 65;
            if (isSenior) {
                try { sessionStorage.setItem('ttsTarget', 'choice_takeout'); } catch (e) {}
            }
            const target = isSenior ? 'order-type.html' : 'order-type2.html';
            // Î∂ÄÎìúÎüΩÍ≤å ÌôîÎ©¥ÏùÑ ÏÇ¨ÎùºÏßÄÍ≤å Ìïú Îí§ Ïù¥ÎèôÌï¥Ïöî
            document.body.style.transition = 'opacity 0.5s ease';
            document.body.style.opacity = '0';
            setTimeout(() => { window.location.href = target; }, 500);
        }
        
        // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ ÏßÄÏõê
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ' ' || event.key === 'Space') {
                startAgeDetection();
            }
        });
        
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Í∞úÏÑ†
        document.addEventListener('touchstart', function(event) {
            event.target.style.transform = 'scale(0.98)';
        });
        
        document.addEventListener('touchend', function(event) {
            event.target.style.transform = 'scale(1)';
            startAgeDetection();
        });
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏûêÎèô ÏãúÏûë(Î©îÏù∏ÏóêÏÑú ÎÑòÏñ¥Ïò® ÌîåÎûòÍ∑∏ ÌôïÏù∏)
        window.addEventListener('load', function() {
            try {
                const auto = sessionStorage.getItem('autoStartDetection');
                if (auto === '1') {
                    sessionStorage.removeItem('autoStartDetection');
                    startAgeDetection();
                }
            } catch (e) {}
        });
    </script>
</body>
</html>