<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì—°ë ¹ íŒë³„</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f0f0f0;
            cursor: pointer;
        }
        
        .kiosk-container {
            width: 100% !important;
            height: 100% !important;
            position: relative;
            background: #FFF9E7;
            overflow: hidden;
            border-radius: 0;
            outline: none;
            outline-offset: 0;
            /* ì™¸ê³½ì„ ì— ì™„ì „íˆ ê½‰ ì°¨ë„ë¡ ê°•ì œ ì ìš© */
            margin: 0 !important;
            padding: 0 !important;
            /* ì™¸ê³½ì„  ê²½ê³„ì— ë”± ë§ì¶¤ */
            min-width: 100%;
            min-height: 100%;
            max-width: 100%;
            max-height: 100%;
        }
        
        .camera-frame {
            width: 600px;
            height: 500px;
            left: 240px;
            top: 500px;
            position: absolute;
            border: 6px solid #333;
            border-radius: 30px;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .camera-frame::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 40px;
        }
        
        .camera-icon {
            font-size: 150px;
            color: #333;
            animation: pulse 1.5s infinite;
            z-index: 2;
            position: relative;
        }
        
        .scanning-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4CAF50, transparent);
            top: 0;
            animation: scan 2s linear infinite;
            z-index: 3;
        }
        
        .scanning-line::before {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background: #4CAF50;
            border-radius: 50%;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 15px #4CAF50;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        .title {
            width: 800px;
            height: 300px;
            left: 140px;
            top: 150px;
            position: absolute;
            text-align: center;
            color: black;
            font-size: 120px;
            font-family: Inter;
            font-weight: 900;
            word-wrap: break-word;
            text-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }
        
        .status-text {
            width: 800px;
            height: 200px;
            left: 140px;
            top: 1100px;
            position: absolute;
            text-align: center;
            justify-content: center;
            display: flex;
            flex-direction: column;
            color: black;
            font-size: 72px;
            font-family: Inter;
            font-weight: 700;
            word-wrap: break-word;
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }
        
        .progress-bar {
            width: 800px;
            height: 15px;
            left: 140px;
            top: 1350px;
            position: absolute;
            background: #E0E0E0;
            border-radius: 8px;
            overflow: hidden;
            z-index: 2;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
            border-radius: 8px;
            width: 0%;
            transition: width 0.1s ease;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
        }
        
        .age-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px;
            font-weight: 900;
            color: #00ff88;
            text-shadow: 0 0 30px #00ff88;
            opacity: 0;
            z-index: 4;
            animation: resultShow 2s ease-in-out forwards;
        }
        
        @keyframes resultShow {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .success-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.2) 0%, transparent 70%);
            opacity: 0;
            animation: successPulse 0.8s ease-in-out forwards;
            z-index: 5;
        }
        
        @keyframes successPulse {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body onclick="startAgeDetection()">
    <div class="kiosk-frame">
        <div class="kiosk-container">
            <div class="title">AI ì—°ë ¹<br/>íŒë³„ ì¤‘</div>
            
            <div class="camera-frame">
                <div class="camera-icon">ğŸ“·</div>
                <div class="scanning-line"></div>
            </div>
            
            <div class="status-text">ì¹´ë©”ë¼ë¡œ ì—°ë ¹ì„<br/>ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="success-effect hidden" id="successEffect"></div>
            
            <!-- ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°ì™€ ìº”ë²„ìŠ¤ëŠ” í™”ë©´ì— ë³´ì´ì§€ ì•Šê²Œ ìˆ¨ê²¨ë‘˜ê²Œìš” -->
            <video id="camera" autoplay playsinline style="display:none; position:absolute; left:24px; bottom:24px; width:240px; height:180px; border-radius: 12px; border: 2px solid #000; opacity: .2;"></video>
            <canvas id="snapshot" width="640" height="480" style="display:none;"></canvas>
        </div>
    </div>
    
    <script>
        // ì´ˆë“±í•™ìƒë„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì‰¬ìš´ ë§ë¡œ ì£¼ì„ì„ ë‹¬ì•„ë‘ì—ˆì–´ìš”!
        // 1) ì„œë²„ ì£¼ì†Œë¥¼ ì ì–´ë‘¡ë‹ˆë‹¤. (Flask ì„œë²„ê°€ ì´ ì£¼ì†Œë¡œ ì—´ë ¤ìˆì–´ìš”)
        const API_BASE = 'http://localhost:5000';
        
        // 2) í™”ë©´ì˜ ë¬¸êµ¬ì™€ ì¹´ë©”ë¼ ìš”ì†Œë¥¼ ì°¾ì•„ìš”
        const $video = document.getElementById('camera');
        const $canvas = document.getElementById('snapshot');
        
        let isDetecting = false;
        let progress = 0;
        let analyzedAvg = null; // ì„œë²„ì—ì„œ ë°›ì€ ë‚˜ì´ í‰ê· ì„ ì—¬ê¸°ì— ì €ì¥í• ê²Œìš”
        
        function startAgeDetection() {
            if (isDetecting) return;
            
            isDetecting = true;
            progress = 0;
            
            // ì§„í–‰ë¥  ë°” ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ë” ì²œì²œíˆ)
            const progressFill = document.getElementById('progressFill');
            const statusText = document.querySelector('.status-text');
            
            const progressInterval = setInterval(() => {
                progress += 2; // 5 â†’ 2ë¡œ ì¤„ì—¬ì„œ ë” ì²œì²œíˆ
                progressFill.style.width = progress + '%';
                
                // ì§„í–‰ë¥ ì´ 90%ê¹Œì§€ë§Œ ê°€ê³ , ì‹¤ì œ ë¶„ì„ ì™„ë£Œ í›„ 100%ë¡œ ì™„ì„±
                if (progress >= 90) {
                    clearInterval(progressInterval);
                    // ì—¬ê¸°ì„œëŠ” showDetectionComplete()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
                }
            }, 150); // 100ms â†’ 150msë¡œ ëŠ˜ë ¤ì„œ ë” ì²œì²œíˆ
            
            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                statusText.innerHTML = 'ì–¼êµ´ ì¸ì‹ ì¤‘...<br/>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';
            }, 800);
            
            setTimeout(() => {
                statusText.innerHTML = 'ì—°ë ¹ ë¶„ì„ ì¤‘...<br/>ê±°ì˜ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
            }, 2000); // 1500 â†’ 2000ìœ¼ë¡œ ëŠ˜ë¦¼

            // 3) ì‹¤ì œë¡œ ì¹´ë©”ë¼ë¡œ ì‚¬ì§„ì„ ì°ê³ , ì„œë²„ì— ë³´ë‚´ì„œ ë‚˜ì´ë¥¼ ë¶„ì„í•´ìš”
            (async () => {
                try {
                    const shots = [];
                    // ì‚¬ì§„ì„ 2ì¥ ì°ì–´ì„œ ë” ì •í™•í•˜ê²Œ í•´ìš”
                    for (let i = 0; i < 2; i++) {
                        const dataURL = await captureDataURL();
                        shots.push(dataURL);
                    }
                    const result = await analyzeOnServer(shots);
                    analyzedAvg = Math.round((result.average || 0));
                    
                    // ì‹¤ì œ ë¶„ì„ì´ ì™„ë£Œëœ í›„ì—ë§Œ ì§„í–‰ë¥ ì„ 100%ë¡œ ë§Œë“¤ê³  ì™„ë£Œ ì²˜ë¦¬
                    progressFill.style.width = '100%';
                    showDetectionComplete();
                } catch (error) {
                    // ì—ëŸ¬ê°€ ë‚˜ë„ ê±±ì •í•˜ì§€ ë§ˆì„¸ìš”. ê¸°ë³¸ê°’ 0ìœ¼ë¡œ ì§„í–‰í•´ìš” (ì•ˆì „í•˜ê²Œ)
                    analyzedAvg = 0;
                    console.error(error);
                    
                    // ì—ëŸ¬ê°€ ë‚˜ë„ ì§„í–‰ë¥ ì„ 100%ë¡œ ë§Œë“¤ê³  ì™„ë£Œ ì²˜ë¦¬
                    progressFill.style.width = '100%';
                    showDetectionComplete();
                }
            })();
        }
        
        function showDetectionComplete() {
            const statusText = document.querySelector('.status-text');
            const successEffect = document.getElementById('successEffect');
            
            // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
            statusText.innerHTML = 'ì—°ë ¹ íŒì • ì™„ë£Œ!<br/>ì£¼ë¬¸ì„ ì‹œì‘í•©ë‹ˆë‹¤';
            
            // ì„±ê³µ íš¨ê³¼ í‘œì‹œ
            successEffect.classList.remove('hidden');
            
            // 1ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ì´ë™ (ë¶„ì„ëœ í‰ê·  ë‚˜ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ê¸°)
            setTimeout(() => {
                const avg = typeof analyzedAvg === 'number' ? analyzedAvg : 0;
                goNext(avg);
            }, 1000);
        }

        // 4) ì„œë²„ë¡œ ì‚¬ì§„ì„ ë³´ë‚´ì„œ í‰ê·  ë‚˜ì´ë¥¼ ë°›ì•„ìš”
        async function analyzeOnServer(images){
            // ì„œë²„ì— JSONìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤. { images: [dataURL, dataURL] }
            const res = await fetch(API_BASE + '/analyze-age', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ images })
            });
            if (!res.ok) throw new Error('ì„œë²„ ì—ëŸ¬: ' + res.status);
            return await res.json();
        }

        async function captureDataURL(){
            // ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ê³ , í™”ë©´ì— ë³´ì´ì§€ ì•Šê²Œ ì˜ìƒì„ ë°›ì•„ìš”
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio:false });
            $video.srcObject = stream;
            // ì¹´ë©”ë¼ê°€ ì¼œì§ˆ ì‹œê°„ì„ ì¡°ê¸ˆ ê¸°ë‹¤ë ¤ìš”
            await new Promise(r => setTimeout(r, 900));
            // ë¹„ë””ì˜¤ì˜ ì‹¤ì œ ë„ˆë¹„/ë†’ì´ë¥¼ ê°€ì ¸ì™€ìš” (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
            const w = $video.videoWidth || 640; 
            const h = $video.videoHeight || 480;
            $canvas.width = w; 
            $canvas.height = h;
            // ìº”ë²„ìŠ¤ì— í˜„ì¬ í™”ë©´ì„ ê·¸ë ¤ìš” (ì‚¬ì§„ ì°ê¸°)
            $canvas.getContext('2d').drawImage($video, 0, 0, w, h);
            // Base64 JPEG ë°ì´í„°ë¡œ ë°”ê¿”ì„œ ì„œë²„ì— ë³´ë‚¼ ì¤€ë¹„ë¥¼ í•´ìš”
            const dataURL = $canvas.toDataURL('image/jpeg', 0.9);
            // ì¹´ë©”ë¼ ë„ê¸° (ì•ˆì „í•˜ê²Œ ìì› í•´ì œ)
            stream.getTracks().forEach(t => t.stop());
            return dataURL;
        }

        // 6) í‰ê·  ë‚˜ì´ê°€ 65ì„¸ ì´ìƒì´ë©´ order-type, ì•„ë‹ˆë©´ order-type2ë¡œ ì´ë™í•´ìš”
        function goNext(avg){
            try { sessionStorage.setItem('ageAvg', String(avg)); } catch (e) {}
            const isSenior = avg >= 65;
            if (isSenior) {
                try { sessionStorage.setItem('ttsTarget', 'choice_takeout'); } catch (e) {}
            }
            const target = isSenior ? 'order-type.html' : 'order-type2.html';
            // ë¶€ë“œëŸ½ê²Œ í™”ë©´ì„ ì‚¬ë¼ì§€ê²Œ í•œ ë’¤ ì´ë™í•´ìš”
            document.body.style.transition = 'opacity 0.5s ease';
            document.body.style.opacity = '0';
            setTimeout(() => { window.location.href = target; }, 500);
        }
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì›
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ' ' || event.key === 'Space') {
                startAgeDetection();
            }
        });
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ ê°œì„ 
        document.addEventListener('touchstart', function(event) {
            event.target.style.transform = 'scale(0.98)';
        });
        
        document.addEventListener('touchend', function(event) {
            event.target.style.transform = 'scale(1)';
            startAgeDetection();
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹œì‘(ë©”ì¸ì—ì„œ ë„˜ì–´ì˜¨ í”Œë˜ê·¸ í™•ì¸)
        window.addEventListener('load', function() {
            try {
                const auto = sessionStorage.getItem('autoStartDetection');
                if (auto === '1') {
                    sessionStorage.removeItem('autoStartDetection');
                    startAgeDetection();
                }
            } catch (e) {}
        });
    </script>
</body>
</html>